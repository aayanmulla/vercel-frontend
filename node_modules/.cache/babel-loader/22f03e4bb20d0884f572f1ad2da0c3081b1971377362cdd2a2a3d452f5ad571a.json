{"ast":null,"code":"import React,{useEffect,useState}from\"react\";import DatePicker from\"react-datepicker\";import\"react-datepicker/dist/react-datepicker.css\";import\"./Bookings.css\";import Navbar from\"../NavBar/NavBar\";import Reservation from\"../Reservations/Reservation\";import Footer from\"../Footer/Footer\";import{FaCalendarAlt}from\"react-icons/fa\";// Import calendar icon\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const Bookings=()=>{const[parkingSlots,setParkingSlots]=useState([]);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[bookedSlotId]=useState(null);const[selectedSlotId,setSelectedSlotId]=useState(null);const[selectedTimeSlot,setSelectedTimeSlot]=useState(\"\");const[selectedDate,setSelectedDate]=useState(null);// Custom input component that shows calendar icon and selected date\nconst CustomDateInput=/*#__PURE__*/React.forwardRef((_ref,ref)=>{let{value,onClick}=_ref;return/*#__PURE__*/_jsxs(\"div\",{className:\"custom-date-input\",onClick:onClick,ref:ref,children:[/*#__PURE__*/_jsx(FaCalendarAlt,{className:\"calendar-icon\"}),value&&/*#__PURE__*/_jsx(\"span\",{className:\"selected-date\",children:value})]});});const fetchAllData=async()=>{setLoading(true);try{const[parkingRes,latestRes,reservedRes]=await Promise.all([fetch(\"http://localhost:5001/api/parking/slots\"),fetch(\"http://localhost:5001/api/slots/latest-booked-slot\"),fetch(\"http://localhost:5001/api/reserved/slots\")]);if(!parkingRes.ok||!latestRes.ok||!reservedRes.ok){throw new Error(\"Failed to fetch one or more data sources\");}const parkingData=await parkingRes.json();const latestData=await latestRes.json();const reservedData=await reservedRes.json();const parkingSlots=parkingData.parkingSlots||[];const reservedSlots=reservedData.parkingSlots||[];const latestBookedSlotId=latestData.latestBookedSlotId;const reservedMap=new Map(reservedSlots.map(slot=>[slot.id,slot]));const updatedSlots=parkingSlots.map(slot=>{if(reservedMap.has(slot.id)){return reservedMap.get(slot.id);// Use reserved slot data (includes timeSlot)\n}return slot;});if(latestBookedSlotId){const slotIndex=updatedSlots.findIndex(slot=>slot.id===latestBookedSlotId);if(slotIndex!==-1){updatedSlots[slotIndex]={...updatedSlots[slotIndex],isOccupied:true,status:\"occupied\"};}else{updatedSlots.push({id:latestBookedSlotId,isOccupied:true,status:\"occupied\"});}}setParkingSlots(updatedSlots);return updatedSlots;}catch(error){console.error(\"Error fetching data:\",error);setError(error.message);return[];}finally{setLoading(false);}};useEffect(()=>{fetchAllData();const interval=setInterval(fetchAllData,180000);return()=>clearInterval(interval);},[]);const handlePayment=async slotId=>{const bookingDate=selectedDate||new Date();if(!selectedTimeSlot){alert(\"Please select a time slot before proceeding with payment.\");return;}const options={key:\"rzp_test_8aHz8s9WnoELui\",amount:500*100,currency:\"INR\",name:\"ParkEz\",description:`Parking Slot Payment: ${bookingDate.toLocaleDateString()} ${selectedTimeSlot}`,handler:async function(response){try{console.log('Fetching slot details for slotId:',slotId);const slotRes=await fetch(`http://localhost:5001/api/reserved/slotNumber/${slotId}`,{method:\"GET\",headers:{\"Content-Type\":\"application/json\",\"Authorization\":`Bearer ${localStorage.getItem('token')}`}});if(!slotRes.ok){const errorText=await slotRes.text();console.error(\"Error fetching slot:\",slotRes.status,errorText);throw new Error(\"Slot not found\");}const slotData=await slotRes.json();if(!slotData._id){alert(\"Slot not found. Please try again.\");return;}const objectId=slotData._id;console.log('Fetched objectId:',objectId);const updateRes=await fetch(`http://localhost:5001/api/reserved/${objectId}`,{method:\"PATCH\",headers:{\"Content-Type\":\"application/json\",\"Authorization\":`Bearer ${localStorage.getItem('token')}`},body:JSON.stringify({isOccupied:true,paymentId:response.razorpay_payment_id,timeSlot:selectedTimeSlot,bookedAt:bookingDate.toISOString(),status:'occupied'})});if(!updateRes.ok){const errorText=await updateRes.text();console.error(\"Error updating slot:\",updateRes.status,errorText);throw new Error(\"Failed to update slot status\");}console.log(\"Slot successfully updated!\");await fetchAllData();alert(`Payment successful! Your slot has been reserved for ${bookingDate.toLocaleDateString()} ${selectedTimeSlot}`);}catch(error){console.error(\"Payment processing error:\",error);alert(\"Payment succeeded but error updating reservation. Contact support.\");}},prefill:{name:\"Aayan Mulla\",email:\"aayanmulla10@gmail.com\",contact:\"7083076077\"},theme:{color:\"#3399cc\"}};try{const rzp1=new window.Razorpay(options);rzp1.open();}catch(error){console.error(\"Error opening payment dialog:\",error);alert(\"Failed to initialize payment. Please try again.\");}};const handleDateChange=date=>{setSelectedDate(date);setSelectedSlotId(null);setSelectedTimeSlot(\"\");};return/*#__PURE__*/_jsxs(\"div\",{className:\"bookings-container\",children:[/*#__PURE__*/_jsx(Navbar,{}),/*#__PURE__*/_jsxs(\"div\",{className:\"bookings-content\",children:[/*#__PURE__*/_jsx(\"h1\",{className:\"bookings-heading\",children:\"Ajeenkya DY Patil Parking Zone\"}),loading?/*#__PURE__*/_jsx(\"p\",{children:\"Loading parking slots...\"}):error?/*#__PURE__*/_jsx(\"p\",{className:\"error-message\",children:error}):/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{className:\"date-picker-container\",children:/*#__PURE__*/_jsx(DatePicker,{selected:selectedDate,onChange:handleDateChange,minDate:new Date(),customInput:/*#__PURE__*/_jsx(CustomDateInput,{}),dateFormat:\"MMMM d, yyyy\",placeholderText:\"\",withPortal:true})}),/*#__PURE__*/_jsx(\"div\",{className:\"bookings-grid\",children:parkingSlots.map(slot=>{const isOccupied=slot.isOccupied||bookedSlotId===slot.id;return/*#__PURE__*/_jsxs(\"div\",{className:`parking-slot ${slot.isOccupied===null?\"under-construction\":isOccupied?\"occupied\":\"available\"}`,onClick:()=>{if(!slot.isOccupied&&slot.isOccupied!==null){setSelectedSlotId(slot.id);}},children:[/*#__PURE__*/_jsxs(\"span\",{children:[\"Slot \",slot.id]}),/*#__PURE__*/_jsx(\"span\",{children:slot.isOccupied===null?\"Under Construction\":isOccupied?slot.timeSlot?`Booked for ${slot.timeSlot}`:\"Occupied\":\"Available\"}),selectedSlotId===slot.id&&!isOccupied&&/*#__PURE__*/_jsxs(\"div\",{className:\"time-slot-selection\",children:[/*#__PURE__*/_jsx(\"label\",{children:\"Select Time Slot:\"}),/*#__PURE__*/_jsxs(\"select\",{value:selectedTimeSlot,onChange:e=>setSelectedTimeSlot(e.target.value),children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"-- Select --\"}),/*#__PURE__*/_jsx(\"option\",{value:\"9 AM - 12 PM\",children:\"9 AM - 12 PM\"}),/*#__PURE__*/_jsx(\"option\",{value:\"12 PM - 3 PM\",children:\"12 PM - 3 PM\"}),/*#__PURE__*/_jsx(\"option\",{value:\"3 PM - 6 PM\",children:\"3 PM - 6 PM\"}),/*#__PURE__*/_jsx(\"option\",{value:\"6 PM - 9 PM\",children:\"6 PM - 9 PM\"})]}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>handlePayment(slot.id),children:\"Book Now\"})]})]},slot.id);})})]})]}),/*#__PURE__*/_jsx(Reservation,{}),/*#__PURE__*/_jsx(Footer,{})]});};export default Bookings;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}